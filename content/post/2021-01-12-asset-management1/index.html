---
title: 資産運用計画をRで計算してみようと思ったけど…
author: Rikiya Honda
date: '2021-01-12'
slug: asset-management1
categories:
  - blog
tags:
  - finance
description: ''
thumbnail: ''
---

<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/jquery/jquery.min.js"></script>
<link href="index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="index_files/datatables-binding/datatables.js"></script>
<link href="index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="index_files/crosstalk/js/crosstalk.min.js"></script>


<p>こんにちは！</p>
<p>最初に言っておきますが、今回は資産運用計画をRで計算しようとしましたが、上手く出来ませんでした。</p>
<p>その理由は、いくつかありますが、特に</p>
<ul>
<li>金融系の知識が足りない。</li>
<li>R言語を意のままに操れていない。</li>
</ul>
<p>というのが主な原因です。また、知識を身に着けてから再チャレンジしたいですね！</p>
<p>なので、今日は完全に分析半ばで記事が終わります！
(若干の書き捨て感が否めないので、あとで分かりやすいよう書き直します！)</p>
<p>それでもいいという優しい方、一緒にコードを見ていきましょう！</p>
<div id="やろうとしているしていたこと" class="section level2">
<h2>やろうとしている（していた）こと</h2>
<p>複雑な資本の運用計算をRで簡単にすませたい！！</p>
<p>今回エクセルではなく、R言語で計算したいと思った理由は、いくつかのケースを並行して考えたかったからです。
例えば、利子率を変化させてその計画自体を比較したり（例：投資する資産を変える）、時間によって利子率が変動するパターンもシミュレーションしたかったからです。</p>
<p>こんな感じで、いくつかの変数の組み合わせを数十年というスパンで分析したい！と思うと、エクセルだとなかなか厳しかったので、Rを使って分析してみました。</p>
</div>
<div id="分析フロー" class="section level1">
<h1>分析フロー</h1>
<div id="環境" class="section level2">
<h2>環境</h2>
<pre class="r"><code>version</code></pre>
<pre><code>##                _                           
## platform       x86_64-w64-mingw32          
## arch           x86_64                      
## os             mingw32                     
## system         x86_64, mingw32             
## status                                     
## major          4                           
## minor          0.3                         
## year           2020                        
## month          10                          
## day            10                          
## svn rev        79318                       
## language       R                           
## version.string R version 4.0.3 (2020-10-10)
## nickname       Bunny-Wunnies Freak Out</code></pre>
</div>
<div id="パッケージの準備" class="section level2">
<h2>パッケージの準備</h2>
<pre class="r"><code>Packages &lt;- c(&quot;tidyverse&quot;, &quot;ggplot2&quot;, &quot;DT&quot;, &quot;scales&quot;)
lapply(Packages, library, character.only = TRUE)</code></pre>
</div>
<div id="前提条件" class="section level2">
<h2>前提条件</h2>
<ul>
<li><code>interest rate</code>は、期末に支払われる。</li>
<li>途中で貯蓄を引き出すことはできない。</li>
<li>金利と毎月の貯金額は一定。</li>
<li>金利は複利で、年利５％で、毎月組み込まれる式。</li>
<li>毎月の貯金額は、5万円。</li>
<li>運用期間は、2年間（24か月）</li>
</ul>
<p>まず、最初は単純化した条件で計算してみます。</p>
</div>
<div id="変数の準備" class="section level2">
<h2>変数の準備</h2>
<pre class="r"><code>m &lt;- 1:24 # 1か月目から、24か月目の期末まで
ms &lt;- rep(50000, length(m)) 　# 毎月5万円の積み立て
r &lt;- rep(0.05, length(m))　# 5%の利子率（固定）
ms_r &lt;- ms * (1 + r)　# 毎月の積立金額 * 利子率
cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
cum_ms_r_moment &lt;- (50000 * (1.05) - (50000 * 1.05 ^ (1:24 + 1))) / (1 - 1.05)  # その時の運用額累計を表示したい
percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
n &lt;- 24:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
r2 &lt;- (1 + r / 12) ^ sort(length(n):1, decreasing = TRUE) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
ms_r2 &lt;- ms * r2　# 毎月の積立金額 * 利子率
cum_ms_r2_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視</code></pre>
</div>
<div id="データフレーム化" class="section level2">
<h2>データフレーム化</h2>
<pre class="r"><code>plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                   n, r2, ms_r2, cum_ms_r2_future) %&gt;% round(digits = 2)

datatable(plan)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000,50000],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05],[52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500,52500],[50000,100000,150000,200000,250000,300000,350000,400000,450000,500000,550000,600000,650000,700000,750000,800000,850000,900000,950000,1000000,1050000,1100000,1150000,1200000],[52500,107625,165506.25,226281.56,290095.64,357100.42,427455.44,501328.22,578894.63,660339.36,745856.33,835649.14,929931.6,1028928.18,1132874.59,1242018.32,1356619.23,1476950.2,1603297.71,1735962.59,1875260.72,2021523.76,2175099.94,2336354.94],[1.05,1.08,1.1,1.13,1.16,1.19,1.22,1.25,1.29,1.32,1.36,1.39,1.43,1.47,1.51,1.55,1.6,1.64,1.69,1.74,1.79,1.84,1.89,1.95],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[1.1,1.1,1.1,1.09,1.09,1.08,1.08,1.07,1.07,1.06,1.06,1.06,1.05,1.05,1.04,1.04,1.03,1.03,1.03,1.02,1.02,1.01,1.01,1],[55247.07,55017.83,54789.54,54562.19,54335.79,54110.33,53885.81,53662.22,53439.55,53217.81,52996.99,52777.09,52558.09,52340.01,52122.83,51906.56,51691.18,51476.69,51263.09,51050.38,50838.56,50627.61,50417.53,50208.33],[55247.07,110264.89,165054.43,219616.62,273952.42,328062.75,381948.56,435610.78,489050.33,542268.15,595265.14,648042.22,700600.32,752940.33,805063.16,856969.72,908660.9,960137.58,1011400.68,1062451.06,1113289.62,1163917.23,1214334.76,1264543.09]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>ms_r2<\/th>\n      <th>cum_ms_r2_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="グラフ表示" class="section level2">
<h2>グラフ表示</h2>
<pre class="r"><code>ggplot(plan, aes(x = m)) +
  geom_smooth(aes(y = cum_ms, color= &quot;毎月貯金(金利なし）&quot;)) +
  geom_smooth(aes(y = cum_ms_r_moment, color = &quot;毎月運用(金利あり）&quot;)) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(0, 24, by = 3)) +
  xlab(&quot;運用経過累積月（ヶ月）&quot;) +
  ylab(&quot;運用金額　（円）&quot;) +
  labs(title = &quot;貯金積み立て金利ありvs.金利なし&quot;,
       subtitle = &quot;金利ありだと、約100万の差ができる&quot;)</code></pre>
<pre><code>FALSE `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
FALSE `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="データフレームを自動で作れる関数を作る" class="section level2">
<h2>データフレームを自動で作れる関数を作る</h2>
<pre class="r"><code>saving_plan &lt;- function(Month, Save, R) {
  m &lt;- 1:Month # １ヶ月目から、Monthヶ月目の期末まで
  ms &lt;- rep(Save, length(m)) 　
  r &lt;- rep(R, length(m))
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (Save * (1 + R) - (Save * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対してはn回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # Monthヶ月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}</code></pre>
<div id="試しに変数を入れてみる" class="section level3">
<h3>試しに変数を入れてみる</h3>
<pre class="r"><code>df &lt;- saving_plan(24, 5, 0.05) %&gt;% round(digits = 2)
datatable(df)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05],[5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25],[5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120],[5.25,10.76,16.55,22.63,29.01,35.71,42.75,50.13,57.89,66.03,74.59,83.56,92.99,102.89,113.29,124.2,135.66,147.7,160.33,173.6,187.53,202.15,217.51,233.64],[1.05,1.08,1.1,1.13,1.16,1.19,1.22,1.25,1.29,1.32,1.36,1.39,1.43,1.47,1.51,1.55,1.6,1.64,1.69,1.74,1.79,1.84,1.89,1.95],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[1,1.01,1.01,1.02,1.02,1.03,1.03,1.03,1.04,1.04,1.05,1.05,1.06,1.06,1.06,1.07,1.07,1.08,1.08,1.09,1.09,1.1,1.1,1.1],[55247.07,110264.89,165054.43,219616.62,273952.42,328062.75,381948.56,435610.78,489050.33,542268.15,595265.14,648042.22,700600.32,752940.33,805063.16,856969.72,908660.9,960137.58,1011400.68,1062451.06,1113289.62,1163917.23,1214334.76,1264543.09]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>cum_ms_r_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="複数のプランを比べる" class="section level2">
<h2>複数のプランを比べる</h2>
<pre class="r"><code>### 複数のプランをつくる。
A &lt;- saving_plan(24, 50000, 0.05)
B &lt;- saving_plan(24, 50000, 0.075)
C &lt;- saving_plan(24, 50000, 0.1)

### 複数のプランを作る際に必要な項目に絞る
plans &lt;- data.frame(A[1],A[6],B[6], C[6]) %&gt;% as_tibble()
plans2 &lt;- plans %&gt;% 
  select(
    Month = m, 
    caseA = cum_ms_r_moment,
    caseB = cum_ms_r_moment.1,
    caseC = cum_ms_r_moment.2
  ) %&gt;% 
  round(digits = 2)

datatable(plans2)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[52500,107625,165506.25,226281.56,290095.64,357100.42,427455.44,501328.22,578894.63,660339.36,745856.33,835649.14,929931.6,1028928.18,1132874.59,1242018.32,1356619.23,1476950.2,1603297.71,1735962.59,1875260.72,2021523.76,2175099.94,2336354.94],[53750,111531.25,173646.09,240419.55,312201.02,389366.09,472318.55,561492.44,657354.37,760405.95,871186.4,990275.38,1118296.03,1255918.24,1403862.1,1562901.76,1733869.39,1917659.6,2115234.07,2327626.62,2555948.62,2801394.76,3065249.37,3348893.08],[55000,115500,182050,255255,335780.5,424358.55,521794.41,628973.85,746871.23,876558.35,1019214.19,1176135.61,1348749.17,1538624.08,1747486.49,1977235.14,2229958.66,2507954.52,2813749.97,3150124.97,3520137.47,3927151.22,4374866.34,4867352.97]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Month<\/th>\n      <th>caseA<\/th>\n      <th>caseB<\/th>\n      <th>caseC<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="グラフ化する" class="section level2">
<h2>グラフ化する</h2>
<pre class="r"><code>ggplot(plans2, aes(x = Month)) +
  geom_smooth(aes(y = caseA, color = &quot;caseC&quot;)) +
  geom_smooth(aes(y = caseB, color = &quot;caseB&quot;)) +
  geom_smooth(aes(y = caseC, color = &quot;caseA&quot;)) + 
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(0, 24, by = 3)) +
  xlab(&quot;運用経過累積月（ヶ月）&quot;) +
  ylab(&quot;運用金額　（円）&quot;) +
  labs(title = &quot;貯金積み立てプラン比較&quot;,
       subtitle = &quot;&quot;)</code></pre>
<pre><code>FALSE `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
FALSE `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
FALSE `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
</div>
<div id="モデルを複雑化する" class="section level1">
<h1>モデルを複雑化する</h1>
<p>(そろそろエクセルじゃ限界か？)</p>
<div id="前提条件-1" class="section level2">
<h2>前提条件</h2>
<ul>
<li><code>interest rate</code>は、期末に支払われる。</li>
<li>途中で貯蓄を引き出すことはできない。</li>
<li>金利と毎月の貯金額は一定→×</li>
<li>→月々の貯金を時間と共に増加させる</li>
<li>→金利は金利を固定ではなく、金利を<code>R</code>%を平均値とする正規分布に近似する複利に変える。(リスク資産で運用する場合を想定する。)</li>
<li>初月の貯金額は、<code>Save</code>万円で、変数<code>Increase_by</code>の等比数列とする。</li>
<li>運用期間は、<code>Month</code>ヶ月）</li>
</ul>
</div>
<div id="関数を作る" class="section level2">
<h2>関数を作る</h2>
<pre class="r"><code>saving_plan2 &lt;- function(Month, Save_first, Increase_by, R, SD) {
  m &lt;- 1:Month # 一か月目から、Monthか月目の期末まで
  ms &lt;- seq(Save_first, by = Increase_by, length.out = Month)  　
  r &lt;- rnorm(n = Month, mean = R, sd = SD)
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (ms * (1 + R) - (ms * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１ヶ月目の貯金額に対してはn回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # mヶ月後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # Monthヶ月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}</code></pre>
<div id="確認する" class="section level3">
<h3>確認する</h3>
<pre class="r"><code>plan3 &lt;- saving_plan2(24, 50000, 1000, 0.05, 1) %&gt;% round(digits = 2)
datatable(plan3)</code></pre>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[50000,51000,52000,53000,54000,55000,56000,57000,58000,59000,60000,61000,62000,63000,64000,65000,66000,67000,68000,69000,70000,71000,72000,73000],[-0.21,-0.22,0.18,-0.52,-0.5,0.6,0.13,-0.59,0.52,0.11,1.27,0.02,0.62,-1.6,0.65,-1.05,-0.02,0.01,-0.41,-1.64,0.17,-1.09,-1.48,-1.62],[39452.49,39919.77,61160.18,25542.58,27105.84,87991.03,63256.86,23397.07,88194.64,65199.32,136199.68,62337.77,100384.62,-37709.49,105901.32,-3287.84,64368.43,67355.09,39796.64,-43839.68,81711.1,-6659.65,-34420.22,-45107.06],[50000,101000,153000,206000,260000,315000,371000,428000,486000,545000,605000,666000,728000,791000,855000,920000,986000,1053000,1121000,1190000,1260000,1331000,1403000,1476000],[52500,109777.5,172126.5,239858.46,313303.29,392810.46,478750.1,571514.17,671517.77,779200.44,895027.59,1019491.95,1153115.18,1296449.51,1450079.47,1614623.81,1790737.39,1979113.26,2180484.88,2395628.37,2625365.01,2870563.73,3132143.92,3411078.21],[1.05,1.09,1.13,1.16,1.21,1.25,1.29,1.34,1.38,1.43,1.48,1.53,1.58,1.64,1.7,1.76,1.82,1.88,1.95,2.01,2.08,2.16,2.23,2.31],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[0.98,0.96,1.04,0.84,0.81,1.34,1.08,0.67,1.47,1.09,3.02,1.02,1.92,0.14,2.22,0.23,0.97,1.01,0.51,0.05,1.34,0.12,0.05,0.03],[55247.07,110264.89,165054.43,219616.62,273952.42,328062.75,381948.56,435610.78,489050.33,542268.15,595265.14,648042.22,700600.32,752940.33,805063.16,856969.72,908660.9,960137.58,1011400.68,1062451.06,1113289.62,1163917.23,1214334.76,1264543.09]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>cum_ms_r_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="グラフ化する-1" class="section level3">
<h3>グラフ化する</h3>
<pre class="r"><code>ggplot(plan3, aes(x = m)) +
  geom_smooth(aes(y = cum_ms_r_moment, colour = &quot;積み立て（金利あり）&quot;)) +
  geom_smooth(aes(y = cum_ms, colour = &quot;積み立て（金利なし）&quot;)) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(0, 24, by = 3)) +
  xlab(&quot;運用経過累積月（ヶ月）&quot;) +
  ylab(&quot;運用金額　（円）&quot;) +
  labs(title = &quot;貯金積み立て金利ありvs.金利なし&quot;,
       subtitle = &quot;&quot;)</code></pre>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
</div>
<div id="最後に" class="section level2">
<h2>最後に、、、</h2>
<p>とりあえず、関数と図をプロットできる形にはできたのですが、リスク資産のボラティリティや、グラフィックツールとしての<code>ggplot2</code>の知識が足りないと思うので、いったんここで、将来の運用戦略を練るのは、お休みしようと思います。</p>
<ul>
<li>次回やりたいとおもっていること。</li>
<li>さらに洗練されたggpolo2のグラフを書く。</li>
<li>デバッグの仕方に慣れる。</li>
<li>資産運用の際のボラティリティの肌感を身に着ける。</li>
<li>さらに、複数の資産と組み合わせて、ポートフォリオを作り、リスクを分散させたモデルを使った場合の運用ケースを比べる。</li>
</ul>
<div id="学んだこと" class="section level3">
<h3>学んだこと</h3>
<p>自作関数での分析は初めてに近かったため、学ぶことが多かったので簡単にまとめておきます。</p>
<ul>
<li>デバッグの重要性。</li>
<li>ggplot2で重ねるグラフを書くこと。そして、色をうまくつけること。</li>
</ul>
<p>今日もありがとうございました！</p>
<p>Adios!!</p>
<pre class="r"><code>Packages &lt;- c(&quot;tidyverse&quot;, &quot;ggplot2&quot;)
lapply(Packages, library, character.only = TRUE)

## 前提条件
### interest rateは、期末に支払われる。
### 途中で引き出すことはできない。
### 金利と毎月の貯金額は一定。
### 金利は複利で、年利５％で、毎月組み込まれる式。
### 毎月の貯金額は、5万円。
### 運用期間は、2年間（24か月）

## 変数を準備

###sheet1 at_the_moment_value
### m:経過した月、ms:毎月の貯金額、r:金利、ms_r:各貯金の1か月経過後の運用額、cum_ms:毎月貯金額累計（金利なし）
### cum_ms_r_moment:毎月の運用額の累計、percent:毎月の累計運用額 / 毎月貯金累計（金利なし）
### n:金利が2年後までにcompoundされる回数（例：1か月目はn = 24)、cum_ms_r_future:2年経過後の各貯金額の累計


m &lt;- 1:24 # 1か月目から、24か月目の期末まで
ms &lt;- rep(5, length(m)) 　
r &lt;- rep(0.05, length(m))
ms_r &lt;- ms * (1 + r)
cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
cum_ms_r_moment &lt;- (5 * (1.05) - (5 * 1.05 ^ (1:24 + 1))) / (1 - 1.05)  # その時の運用額累計を表示したい
percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
n &lt;- 24:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
r2 &lt;- (1 + r / 12) ^ sort(length(n):1, decreasing = TRUE)
#2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
ms_r2 &lt;- ms * r2
cum_ms_r2_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視

## データフレーム化
plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                   n, r2, ms_r2, cum_ms_r2_future)
head(plan)

library(ggplot2)

## グラフ表示
ggplot(plan, aes(x = m)) +
  geom_smooth(aes(y = cum_ms)) +
  geom_smooth(aes(y = cum_ms_r_moment))

##　データフレームを自動で作れる関数を作る
saving_plan &lt;- function(Month, Save, R) {
  m &lt;- 1:Month # 一か月目から、24か月目の期末まで
  ms &lt;- rep(Save, length(m)) 　
  r &lt;- rep(R, length(m))
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (Save * (1 + R) - (Save * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}

df &lt;- saving_plan(24, 5, 0.05)
datatable(df)

## 複数のプランを比べる

### 複数のプランをつくる。
A &lt;- saving_plan(24, 5, 0.05)
B &lt;- saving_plan(24, 5, 0.075)
C &lt;- saving_plan(24, 5, 0.1)

### 複数のプランを作る際に必要な項目に絞る
plans &lt;- data.frame(A[1],A[6],B[6], C[6]) %&gt;% as_tibble()
plans2 &lt;- plans %&gt;% 
  select(
    Month = m, 
    caseA = cum_ms_r_moment,
    caseB = cum_ms_r_moment.1,
    caseC = cum_ms_r_moment.2
  ) 

plans2

### グラフ化する
ggplot(plans2, aes(x = Month)) +
  geom_smooth(aes(y = caseA)) +
  geom_smooth(aes(y = caseB)) +
  geom_smooth(aes(y = caseC)) 


# モデルを複雑化する そろそろエクセルじゃ限界か？

## 前提条件
### interest rateは、期末に支払われる。
### 途中で貯蓄を引き出すことはできない。
### 金利と毎月の貯金額は一定。
# →月々の貯金を時間と共に増加させる
# →金利は金利を固定ではなく、金利をr%を平均値とする正規分布に近似する複利に変える。
#つまり、リスク資産で運用する場合を想定する。
### 毎月の貯金額は、5万円。
### 運用期間は、2年間（24か月）

## 関数を作る
saving_plan2 &lt;- function(Month, Save_first, Increase_by, R, SD) {
  m &lt;- 1:Month # 一か月目から、mか月目の期末まで
  ms &lt;- seq(Save_first, by = Increase_by, length.out = Month)  　
  r &lt;- rnorm(n = Month, mean = R, sd = SD)
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (ms * (1 + R) - (ms * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # mヶ月後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # mか月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}

###確認する

plan3 &lt;- saving_plan2(24, 50000, 1000, 0.05, 1)


### グラフ化する

ggplot(plan3, aes(x = m)) +
  geom_smooth(aes(y = cum_ms_r_moment, colour = &quot;積み立て（金利あり）&quot;)) +
  geom_smooth(aes(y = cum_ms, colour = &quot;積み立て（金利なし）&quot;)) +
  scale_y_continuous(labels = comma) +
  xlab(&quot;ヶ月&quot;) +
  ylab(&quot;円&quot;)</code></pre>
</div>
</div>
</div>
