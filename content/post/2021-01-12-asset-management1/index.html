---
title: 資産運用計画をRで計算してみようと思ったけど…
author: Rikiya Honda
date: '2021-01-12'
slug: asset-management1
categories:
  - blog
tags:
  - finance
description: ''
thumbnail: ''
---

<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/jquery/jquery.min.js"></script>
<link href="index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="index_files/datatables-binding/datatables.js"></script>
<link href="index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="index_files/crosstalk/js/crosstalk.min.js"></script>


<p>こんにちは！</p>
<p>最初に言っておきますが、今日は、資産運用計画をRで計算しようとしましたが、上手く出ませんでした。</p>
<p>その理由は、いくつかありますが、特に
* 金融系の知識が足りない。
* R言語を意のままに操れていない。</p>
<p>というのが挙げられます。</p>
<p>なので、今日は完全に分析半ばで記事が終わります！</p>
<p>それでもいいという優しい方、読んでいただければ僕の励みになります！</p>
<p>では、見ていきましょう！</p>
<div id="やろうとしているしていたこと" class="section level1">
<h1>やろうとしている（していた）こと</h1>
<p>複雑な資本の運用計算をRで簡単にすませたい！！</p>
<p>今回、エクセルではなく、R言語でやりたいと思った理由は、いくつかのケースを並行して考えたかったからです。
例えば、利子率って、投資する資産によって変わるし、加えて、時間軸を書ければ、その変動幅も変わります。
そのようないくつかの変数の組み合わせを数十年というスパンで分析したい！と思うと、エクセルだとなかなか厳しいんですよね。
なので、Rを使ってやってみました。</p>
</div>
<div id="環境" class="section level1">
<h1>環境</h1>
<pre class="r"><code>version</code></pre>
<pre><code>##                _                           
## platform       x86_64-w64-mingw32          
## arch           x86_64                      
## os             mingw32                     
## system         x86_64, mingw32             
## status                                     
## major          4                           
## minor          0.3                         
## year           2020                        
## month          10                          
## day            10                          
## svn rev        79318                       
## language       R                           
## version.string R version 4.0.3 (2020-10-10)
## nickname       Bunny-Wunnies Freak Out</code></pre>
</div>
<div id="パッケージの準備" class="section level1">
<h1>パッケージの準備</h1>
<pre class="r"><code>Packages &lt;- c(&quot;tidyverse&quot;, &quot;ggplot2&quot;, &quot;DT&quot;, &quot;scales&quot;)
lapply(Packages, library, character.only = TRUE)</code></pre>
<pre><code>## -- Attaching packages --------------------------------------- tidyverse 1.3.0 --</code></pre>
<pre><code>## √ ggplot2 3.3.3     √ purrr   0.3.4
## √ tibble  3.0.4     √ dplyr   1.0.2
## √ tidyr   1.1.2     √ stringr 1.4.0
## √ readr   1.4.0     √ forcats 0.5.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre><code>## 
##  次のパッケージを付け加えます: &#39;scales&#39;</code></pre>
<pre><code>##  以下のオブジェクトは &#39;package:purrr&#39; からマスクされています: 
## 
##      discard</code></pre>
<pre><code>##  以下のオブジェクトは &#39;package:readr&#39; からマスクされています: 
## 
##      col_factor</code></pre>
</div>
<div id="前提条件" class="section level1">
<h1>前提条件</h1>
<ul>
<li>interest rateは、期末に支払われる。</li>
<li>途中で貯蓄を引き出すことはできない。</li>
<li>金利と毎月の貯金額は一定。</li>
<li>金利は複利で、年利５％で、毎月組み込まれる式。</li>
<li>毎月の貯金額は、5万円。</li>
<li>運用期間は、2年間（24か月）</li>
</ul>
<p>まず、最初は単純化した条件で計算してみます。</p>
</div>
<div id="変数の準備" class="section level1">
<h1>変数の準備</h1>
<pre class="r"><code>m &lt;- 1:24 # 1か月目から、24か月目の期末まで
ms &lt;- rep(5, length(m)) 　# 毎月5万円の積み立て
r &lt;- rep(0.05, length(m))　# 5%の利子率（固定）
ms_r &lt;- ms * (1 + r)　# 毎月の積立金額 * 利子率
cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
cum_ms_r_moment &lt;- (5 * (1.05) - (5 * 1.05 ^ (1:24 + 1))) / (1 - 1.05)  # その時の運用額累計を表示したい
percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
n &lt;- 24:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
r2 &lt;- (1 + r / 12) ^ sort(length(n):1, decreasing = TRUE) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
ms_r2 &lt;- ms * r2　# 毎月の積立金額 * 利子率
cum_ms_r2_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視</code></pre>
</div>
<div id="データフレーム化" class="section level1">
<h1>データフレーム化</h1>
<pre class="r"><code>plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                   n, r2, ms_r2, cum_ms_r2_future) 

datatable(plan)</code></pre>
<p><div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05],[5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25],[5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120],[5.25,10.7625,16.550625,22.62815625,29.0095640625,35.710042265625,42.7455443789063,50.1328215978516,57.8894626777442,66.0339358116314,74.5856326022129,83.5649142323236,92.9931599439398,102.892817941137,113.287458838194,124.201831780103,135.661923369108,147.695019537564,160.329770514442,173.596259040164,187.526071992172,202.152375591781,217.50999437137,233.635494089939],[1.05,1.07625,1.103375,1.1314078125,1.1603825625,1.1903347421875,1.22130126796875,1.25332053994629,1.28643250394987,1.32067871623263,1.35610241094933,1.39274857053873,1.43066399913753,1.4698973991591,1.51049945117591,1.55252289725129,1.59602262787186,1.6410557726396,1.68768179488886,1.73596259040164,1.78596259040164,1.83774886901619,1.89139125540322,1.94696245074949],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[1.10494133555833,1.10035651673858,1.09579072206332,1.09124387259418,1.08671588972034,1.08220669515719,1.07771621094492,1.07324435944722,1.06879106334993,1.06435624565968,1.05993982970259,1.05554173912291,1.05116189788173,1.04680023025567,1.04245666083552,1.038131114525,1.03382351653942,1.0295337924044,1.02526186795459,1.02100766933237,1.01677112298659,1.0125521556713,1.00835069444444,1.00416666666667],[5.52470667779163,5.50178258369291,5.47895361031659,5.45621936297088,5.43357944860171,5.41103347578593,5.38858105472458,5.3662217972361,5.34395531674964,5.3217812282984,5.29969914851293,5.27770869561453,5.25580948940866,5.23400115127834,5.2122833041776,5.19065557262499,5.16911758269709,5.147668962022,5.12630933977294,5.10503834666185,5.08385561493297,5.06276077835648,5.04175347222222,5.02083333333333],[5.52470667779163,11.0264892614845,16.5054428718011,21.961662234772,27.3952416833737,32.8062751591597,38.1948562138843,43.5610780111204,48.90503332787,54.2268145561684,59.5265137046813,64.8042224002959,70.0600318897045,75.2940330409829,80.5063163451605,85.6969719177854,90.8660895004825,96.0137584625045,101.140067802277,106.245106148939,111.328961763872,116.391722542229,121.433476014451,126.454309347784]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>ms_r2<\/th>\n      <th>cum_ms_r2_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
# グラフ表示</p>
<pre class="r"><code>ggplot(plan, aes(x = m)) +
  geom_smooth(aes(y = cum_ms, color= &quot;毎月貯金(金利なし）&quot;)) +
  geom_smooth(aes(y = cum_ms_r_moment, color = &quot;毎月運用(金利あり）&quot;)) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(0, 24, by = 3)) +
  xlab(&quot;運用経過累積月（ヶ月）&quot;) +
  ylab(&quot;運用金額　（万円）&quot;)</code></pre>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>#最後に、、、
とりあえず、関数と図をプロットできる形にはできたのですが、リスク資産のボラティリティや、グラフィックツールとしての<code>ggplot2</code>の知識が足りないと思うので、いったんここで、将来の運用戦略を練るのは、お休みしようと思います。</p>
<ul>
<li>次回やりたいとおもっていること。</li>
<li>さらに洗練されたggpolo2のグラフを書く。</li>
<li>デバッグの仕方に慣れる。</li>
<li>資産運用の際のボラティリティの肌感を身に着ける。</li>
<li>さらに、複数の資産と組み合わせて、ポートフォリオを作り、リスクを分散させたモデルを使った場合の運用ケースを比べる。</li>
</ul>
<div id="学んだこと" class="section level2">
<h2>学んだこと</h2>
<p>自作関数での分析は初めてに近かったため、学ぶことが多かったので簡単にまとめておきます。</p>
<ul>
<li>デバッグの重要性。</li>
<li>ggplot2で重ねるグラフを書くこと。そして、色をうまくつけること。</li>
</ul>
<p>今日もありがとうございました！</p>
<p>Adios!!</p>
<pre class="r"><code>Packages &lt;- c(&quot;tidyverse&quot;, &quot;ggplot2&quot;)
lapply(Packages, library, character.only = TRUE)

## 前提条件
### interest rateは、期末に支払われる。
### 途中で引き出すことはできない。
### 金利と毎月の貯金額は一定。
### 金利は複利で、年利５％で、毎月組み込まれる式。
### 毎月の貯金額は、5万円。
### 運用期間は、2年間（24か月）

## 変数を準備

###sheet1 at_the_moment_value
### m:経過した月、ms:毎月の貯金額、r:金利、ms_r:各貯金の1か月経過後の運用額、cum_ms:毎月貯金額累計（金利なし）
### cum_ms_r_moment:毎月の運用額の累計、percent:毎月の累計運用額 / 毎月貯金累計（金利なし）
### n:金利が2年後までにcompoundされる回数（例：1か月目はn = 24)、cum_ms_r_future:2年経過後の各貯金額の累計


m &lt;- 1:24 # 1か月目から、24か月目の期末まで
ms &lt;- rep(5, length(m)) 　
r &lt;- rep(0.05, length(m))
ms_r &lt;- ms * (1 + r)
cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
cum_ms_r_moment &lt;- (5 * (1.05) - (5 * 1.05 ^ (1:24 + 1))) / (1 - 1.05)  # その時の運用額累計を表示したい
percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
n &lt;- 24:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
r2 &lt;- (1 + r / 12) ^ sort(length(n):1, decreasing = TRUE) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
ms_r2 &lt;- ms * r2
cum_ms_r2_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視

## データフレーム化
plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                   n, r2, ms_r2, cum_ms_r2_future)
head(plan)

library(ggplot2)

## グラフ表示
ggplot(plan, aes(x = m)) +
  geom_smooth(aes(y = cum_ms)) +
  geom_smooth(aes(y = cum_ms_r_moment))

##　データフレームを自動で作れる関数を作る
saving_plan &lt;- function(Month, Save, R) {
  m &lt;- 1:Month # 一か月目から、24か月目の期末まで
  ms &lt;- rep(Save, length(m)) 　
  r &lt;- rep(R, length(m))
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (Save * (1 + R) - (Save * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}

df &lt;- saving_plan(24, 5, 0.05)
df

## 複数のプランを比べる

### 複数のプランをつくる。
A &lt;- saving_plan(24, 5, 0.05)
B &lt;- saving_plan(24, 5, 0.075)
C &lt;- saving_plan(24, 5, 0.1)

### 複数のプランを作る際に必要な項目に絞る
plans &lt;- data.frame(A[1],A[6],B[6], C[6]) %&gt;% as_tibble()
plans2 &lt;- plans %&gt;% 
  select(
    Month = m, 
    caseA = cum_ms_r_moment,
    caseB = cum_ms_r_moment.1,
    caseC = cum_ms_r_moment.2
  ) 

plans2

### グラフ化する
ggplot(plans2, aes(x = Month)) +
  geom_smooth(aes(y = caseA)) +
  geom_smooth(aes(y = caseB)) +
  geom_smooth(aes(y = caseC)) 


# モデルを複雑化する そろそろエクセルじゃ限界か？

## 前提条件
### interest rateは、期末に支払われる。
### 途中で貯蓄を引き出すことはできない。
### 金利と毎月の貯金額は一定。
# →月々の貯金を時間と共に増加させる
# →金利は金利を固定ではなく、金利をr%を平均値とする正規分布に近似する複利に変える。
#つまり、リスク資産で運用する場合を想定する。
### 毎月の貯金額は、5万円。
### 運用期間は、2年間（24か月）

## 関数を作る
saving_plan2 &lt;- function(Month, Save_first, Increase_by, R, SD) {
  m &lt;- 1:Month # 一か月目から、mか月目の期末まで
  ms &lt;- seq(Save_first, by = Increase_by, length.out = Month)  　
  r &lt;- rnorm(n = Month, mean = R, sd = SD)
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (ms * (1 + R) - (ms * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # mヶ月後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # mか月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}

plan3 &lt;- saving_plan2(24, 50000, 1000, 0.05, 1)


###確認する
head(df)
library(scales)
ggplot(plan3, aes(x = m)) +
  geom_smooth(aes(y = cum_ms_r_moment, colour = &quot;積み立て（金利あり）&quot;)) +
  geom_smooth(aes(y = cum_ms, colour = &quot;積み立て（金利なし）&quot;)) +
  scale_y_continuous(labels = comma) +
  xlab(&quot;ヶ月&quot;) +
  ylab(&quot;円&quot;)</code></pre>
</div>
</div>
