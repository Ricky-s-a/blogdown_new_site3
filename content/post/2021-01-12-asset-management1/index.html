---
title: 資産運用計画をRで計算してみようと思ったけど…
author: Rikiya Honda
date: '2021-01-12'
slug: asset-management1
categories:
  - blog
tags:
  - finance
description: ''
thumbnail: ''
---

<script src="index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="index_files/jquery/jquery.min.js"></script>
<link href="index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="index_files/datatables-binding/datatables.js"></script>
<link href="index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="index_files/crosstalk/js/crosstalk.min.js"></script>


<p>こんにちは！</p>
<p>最初に言っておきますが、今日は、資産運用計画をRで計算しようとしましたが、上手く出ませんでした。</p>
<p>その理由は、いくつかありますが、特に</p>
<ul>
<li>金融系の知識が足りない。</li>
<li>R言語を意のままに操れていない。</li>
</ul>
<p>というのが挙げられます。</p>
<p>なので、今日は完全に分析半ばで記事が終わります！</p>
<p>それでもいいという優しい方、読んでいただければ僕の励みになります！</p>
<p>では、見ていきましょう！</p>
<div id="やろうとしているしていたこと" class="section level2">
<h2>やろうとしている（していた）こと</h2>
<p>複雑な資本の運用計算をRで簡単にすませたい！！</p>
<p>今回、エクセルではなく、R言語でやりたいと思った理由は、いくつかのケースを並行して考えたかったからです。
例えば、利子率って、投資する資産によって変わるし、加えて、時間軸を書ければ、その変動幅も変わります。
そのようないくつかの変数の組み合わせを数十年というスパンで分析したい！と思うと、エクセルだとなかなか厳しいんですよね。
なので、Rを使ってやってみました。</p>
</div>
<div id="分析フロー" class="section level1">
<h1>分析フロー</h1>
<div id="環境" class="section level2">
<h2>環境</h2>
<pre class="r"><code>version</code></pre>
<pre><code>##                _                           
## platform       x86_64-w64-mingw32          
## arch           x86_64                      
## os             mingw32                     
## system         x86_64, mingw32             
## status                                     
## major          4                           
## minor          0.3                         
## year           2020                        
## month          10                          
## day            10                          
## svn rev        79318                       
## language       R                           
## version.string R version 4.0.3 (2020-10-10)
## nickname       Bunny-Wunnies Freak Out</code></pre>
</div>
<div id="パッケージの準備" class="section level2">
<h2>パッケージの準備</h2>
<pre class="r"><code>Packages &lt;- c(&quot;tidyverse&quot;, &quot;ggplot2&quot;, &quot;DT&quot;, &quot;scales&quot;)
lapply(Packages, library, character.only = TRUE)</code></pre>
<pre><code>## -- Attaching packages --------------------------------------- tidyverse 1.3.0 --</code></pre>
<pre><code>## √ ggplot2 3.3.3     √ purrr   0.3.4
## √ tibble  3.0.4     √ dplyr   1.0.2
## √ tidyr   1.1.2     √ stringr 1.4.0
## √ readr   1.4.0     √ forcats 0.5.0</code></pre>
<pre><code>## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<pre><code>## 
##  次のパッケージを付け加えます: &#39;scales&#39;</code></pre>
<pre><code>##  以下のオブジェクトは &#39;package:purrr&#39; からマスクされています: 
## 
##      discard</code></pre>
<pre><code>##  以下のオブジェクトは &#39;package:readr&#39; からマスクされています: 
## 
##      col_factor</code></pre>
</div>
<div id="前提条件" class="section level2">
<h2>前提条件</h2>
<ul>
<li>interest rateは、期末に支払われる。</li>
<li>途中で貯蓄を引き出すことはできない。</li>
<li>金利と毎月の貯金額は一定。</li>
<li>金利は複利で、年利５％で、毎月組み込まれる式。</li>
<li>毎月の貯金額は、5万円。</li>
<li>運用期間は、2年間（24か月）</li>
</ul>
<p>まず、最初は単純化した条件で計算してみます。</p>
</div>
<div id="変数の準備" class="section level2">
<h2>変数の準備</h2>
<pre class="r"><code>m &lt;- 1:24 # 1か月目から、24か月目の期末まで
ms &lt;- rep(5, length(m)) 　# 毎月5万円の積み立て
r &lt;- rep(0.05, length(m))　# 5%の利子率（固定）
ms_r &lt;- ms * (1 + r)　# 毎月の積立金額 * 利子率
cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
cum_ms_r_moment &lt;- (5 * (1.05) - (5 * 1.05 ^ (1:24 + 1))) / (1 - 1.05)  # その時の運用額累計を表示したい
percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
n &lt;- 24:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
r2 &lt;- (1 + r / 12) ^ sort(length(n):1, decreasing = TRUE) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
ms_r2 &lt;- ms * r2　# 毎月の積立金額 * 利子率
cum_ms_r2_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視</code></pre>
</div>
<div id="データフレーム化" class="section level2">
<h2>データフレーム化</h2>
<pre class="r"><code>plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                   n, r2, ms_r2, cum_ms_r2_future) %&gt;% round(digits = 2)

datatable(plan)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05],[5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25],[5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120],[5.25,10.76,16.55,22.63,29.01,35.71,42.75,50.13,57.89,66.03,74.59,83.56,92.99,102.89,113.29,124.2,135.66,147.7,160.33,173.6,187.53,202.15,217.51,233.64],[1.05,1.08,1.1,1.13,1.16,1.19,1.22,1.25,1.29,1.32,1.36,1.39,1.43,1.47,1.51,1.55,1.6,1.64,1.69,1.74,1.79,1.84,1.89,1.95],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[1.1,1.1,1.1,1.09,1.09,1.08,1.08,1.07,1.07,1.06,1.06,1.06,1.05,1.05,1.04,1.04,1.03,1.03,1.03,1.02,1.02,1.01,1.01,1],[5.52,5.5,5.48,5.46,5.43,5.41,5.39,5.37,5.34,5.32,5.3,5.28,5.26,5.23,5.21,5.19,5.17,5.15,5.13,5.11,5.08,5.06,5.04,5.02],[5.52,11.03,16.51,21.96,27.4,32.81,38.19,43.56,48.91,54.23,59.53,64.8,70.06,75.29,80.51,85.7,90.87,96.01,101.14,106.25,111.33,116.39,121.43,126.45]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>ms_r2<\/th>\n      <th>cum_ms_r2_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10,11]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="グラフ表示" class="section level2">
<h2>グラフ表示</h2>
<pre class="r"><code>ggplot(plan, aes(x = m)) +
  geom_smooth(aes(y = cum_ms, color= &quot;毎月貯金(金利なし）&quot;)) +
  geom_smooth(aes(y = cum_ms_r_moment, color = &quot;毎月運用(金利あり）&quot;)) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(0, 24, by = 3)) +
  xlab(&quot;運用経過累積月（ヶ月）&quot;) +
  ylab(&quot;運用金額　（万円）&quot;)</code></pre>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="データフレームを自動で作れる関数を作る" class="section level2">
<h2>データフレームを自動で作れる関数を作る</h2>
<pre class="r"><code>saving_plan &lt;- function(Month, Save, R) {
  m &lt;- 1:Month # 一か月目から、24か月目の期末まで
  ms &lt;- rep(Save, length(m)) 　
  r &lt;- rep(R, length(m))
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (Save * (1 + R) - (Save * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}</code></pre>
<div id="試しに変数を入れてみる" class="section level3">
<h3>試しに変数を入れてみる</h3>
<pre class="r"><code>df &lt;- saving_plan(24, 5, 0.05) %&gt;% round(digits = 2)
datatable(df)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05],[5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25,5.25],[5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120],[5.25,10.76,16.55,22.63,29.01,35.71,42.75,50.13,57.89,66.03,74.59,83.56,92.99,102.89,113.29,124.2,135.66,147.7,160.33,173.6,187.53,202.15,217.51,233.64],[1.05,1.08,1.1,1.13,1.16,1.19,1.22,1.25,1.29,1.32,1.36,1.39,1.43,1.47,1.51,1.55,1.6,1.64,1.69,1.74,1.79,1.84,1.89,1.95],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[1,1.01,1.01,1.02,1.02,1.03,1.03,1.03,1.04,1.04,1.05,1.05,1.06,1.06,1.06,1.07,1.07,1.08,1.08,1.09,1.09,1.1,1.1,1.1],[5.52,11.03,16.51,21.96,27.4,32.81,38.19,43.56,48.91,54.23,59.53,64.8,70.06,75.29,80.51,85.7,90.87,96.01,101.14,106.25,111.33,116.39,121.43,126.45]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>cum_ms_r_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="複数のプランを比べる" class="section level2">
<h2>複数のプランを比べる</h2>
<pre class="r"><code>### 複数のプランをつくる。
A &lt;- saving_plan(24, 5, 0.05)
B &lt;- saving_plan(24, 5, 0.075)
C &lt;- saving_plan(24, 5, 0.1)

### 複数のプランを作る際に必要な項目に絞る
plans &lt;- data.frame(A[1],A[6],B[6], C[6]) %&gt;% as_tibble()
plans2 &lt;- plans %&gt;% 
  select(
    Month = m, 
    caseA = cum_ms_r_moment,
    caseB = cum_ms_r_moment.1,
    caseC = cum_ms_r_moment.2
  ) %&gt;% 
  round(digits = 2)

datatable(plans2)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[5.25,10.76,16.55,22.63,29.01,35.71,42.75,50.13,57.89,66.03,74.59,83.56,92.99,102.89,113.29,124.2,135.66,147.7,160.33,173.6,187.53,202.15,217.51,233.64],[5.37,11.15,17.36,24.04,31.22,38.94,47.23,56.15,65.74,76.04,87.12,99.03,111.83,125.59,140.39,156.29,173.39,191.77,211.52,232.76,255.59,280.14,306.52,334.89],[5.5,11.55,18.21,25.53,33.58,42.44,52.18,62.9,74.69,87.66,101.92,117.61,134.87,153.86,174.75,197.72,223,250.8,281.37,315.01,352.01,392.72,437.49,486.74]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Month<\/th>\n      <th>caseA<\/th>\n      <th>caseB<\/th>\n      <th>caseC<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="グラフ化する" class="section level2">
<h2>グラフ化する</h2>
<pre class="r"><code>ggplot(plans2, aes(x = Month)) +
  geom_smooth(aes(y = caseA, color = &quot;caseC&quot;)) +
  geom_smooth(aes(y = caseB, color = &quot;caseB&quot;)) +
  geom_smooth(aes(y = caseC, color = &quot;caseA&quot;)) </code></pre>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
</div>
<div id="モデルを複雑化する" class="section level1">
<h1>モデルを複雑化する</h1>
<p>(そろそろエクセルじゃ限界か？)</p>
<div id="前提条件-1" class="section level2">
<h2>前提条件</h2>
<ul>
<li><code>interest rate</code>は、期末に支払われる。</li>
<li>途中で貯蓄を引き出すことはできない。</li>
<li>金利と毎月の貯金額は一定。</li>
<li>→月々の貯金を時間と共に増加させる</li>
<li>→金利は金利を固定ではなく、金利を<code>R</code>%を平均値とする正規分布に近似する複利に変える。(リスク資産で運用する場合を想定する。)</li>
<li>初月の貯金額は、<code>Save</code>万円で、変数<code>Increase_by</code>の等比数列とする。</li>
<li>運用期間は、<code>Month</code>か月）</li>
</ul>
</div>
<div id="関数を作る" class="section level2">
<h2>関数を作る</h2>
<pre class="r"><code>saving_plan2 &lt;- function(Month, Save_first, Increase_by, R, SD) {
  m &lt;- 1:Month # 一か月目から、mか月目の期末まで
  ms &lt;- seq(Save_first, by = Increase_by, length.out = Month)  　
  r &lt;- rnorm(n = Month, mean = R, sd = SD)
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (ms * (1 + R) - (ms * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # mヶ月後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # mか月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}</code></pre>
<div id="確認する" class="section level3">
<h3>確認する</h3>
<pre class="r"><code>plan3 &lt;- saving_plan2(24, 50000, 1000, 0.05, 1) %&gt;% round(digits = 2)
datatable(plan3)</code></pre>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],[50000,51000,52000,53000,54000,55000,56000,57000,58000,59000,60000,61000,62000,63000,64000,65000,66000,67000,68000,69000,70000,71000,72000,73000],[1.31,-0.03,1.65,-0.22,3.05,-0.39,-1.31,-0.79,-2.73,-0.14,-0.17,-0.15,0.99,0.17,0.98,-0.55,1.57,0.18,-1.93,0.27,0.83,-0.83,1.09,0.18],[115394.24,49561.07,137669.41,41236.39,218597.09,33583.43,-17596.69,12236.02,-100399.81,50544.69,49968.61,51568.82,123250.47,73673.04,126837.63,29270.27,169870.47,79351.28,-63574.06,87357.73,127913.6,11927.82,150238.49,85836.01],[50000,101000,153000,206000,260000,315000,371000,428000,486000,545000,605000,666000,728000,791000,855000,920000,986000,1053000,1121000,1190000,1260000,1331000,1403000,1476000],[52500,109777.5,172126.5,239858.46,313303.29,392810.46,478750.1,571514.17,671517.77,779200.44,895027.59,1019491.95,1153115.18,1296449.51,1450079.47,1614623.81,1790737.39,1979113.26,2180484.88,2395628.37,2625365.01,2870563.73,3132143.92,3411078.21],[1.05,1.09,1.13,1.16,1.21,1.25,1.29,1.34,1.38,1.43,1.48,1.53,1.58,1.64,1.7,1.76,1.82,1.88,1.95,2.01,2.08,2.16,2.23,2.31],[24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],[1.11,1,1.47,0.93,3.1,0.82,0.44,0.58,0.1,0.89,0.86,0.86,2.8,1.22,3.25,0.47,8.13,1.32,0.04,1.55,4.06,0.21,7.34,1.42],[5.52,11.03,16.51,21.96,27.4,32.81,38.19,43.56,48.91,54.23,59.53,64.8,70.06,75.29,80.51,85.7,90.87,96.01,101.14,106.25,111.33,116.39,121.43,126.45]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>m<\/th>\n      <th>ms<\/th>\n      <th>r<\/th>\n      <th>ms_r<\/th>\n      <th>cum_ms<\/th>\n      <th>cum_ms_r_moment<\/th>\n      <th>percent<\/th>\n      <th>n<\/th>\n      <th>r2<\/th>\n      <th>cum_ms_r_future<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7,8,9,10]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="グラフ化する-1" class="section level3">
<h3>グラフ化する</h3>
<pre class="r"><code>ggplot(plan3, aes(x = m)) +
  geom_smooth(aes(y = cum_ms_r_moment, colour = &quot;積み立て（金利あり）&quot;)) +
  geom_smooth(aes(y = cum_ms, colour = &quot;積み立て（金利なし）&quot;)) +
  scale_y_continuous(labels = comma) +
  xlab(&quot;ヶ月&quot;) +
  ylab(&quot;円&quot;)</code></pre>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;
## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
</div>
</div>
<div id="最後に" class="section level2">
<h2>最後に、、、</h2>
<p>とりあえず、関数と図をプロットできる形にはできたのですが、リスク資産のボラティリティや、グラフィックツールとしての<code>ggplot2</code>の知識が足りないと思うので、いったんここで、将来の運用戦略を練るのは、お休みしようと思います。</p>
<ul>
<li>次回やりたいとおもっていること。</li>
<li>さらに洗練されたggpolo2のグラフを書く。</li>
<li>デバッグの仕方に慣れる。</li>
<li>資産運用の際のボラティリティの肌感を身に着ける。</li>
<li>さらに、複数の資産と組み合わせて、ポートフォリオを作り、リスクを分散させたモデルを使った場合の運用ケースを比べる。</li>
</ul>
<div id="学んだこと" class="section level3">
<h3>学んだこと</h3>
<p>自作関数での分析は初めてに近かったため、学ぶことが多かったので簡単にまとめておきます。</p>
<ul>
<li>デバッグの重要性。</li>
<li>ggplot2で重ねるグラフを書くこと。そして、色をうまくつけること。</li>
</ul>
<p>今日もありがとうございました！</p>
<p>Adios!!</p>
<pre class="r"><code>Packages &lt;- c(&quot;tidyverse&quot;, &quot;ggplot2&quot;)
lapply(Packages, library, character.only = TRUE)

## 前提条件
### interest rateは、期末に支払われる。
### 途中で引き出すことはできない。
### 金利と毎月の貯金額は一定。
### 金利は複利で、年利５％で、毎月組み込まれる式。
### 毎月の貯金額は、5万円。
### 運用期間は、2年間（24か月）

## 変数を準備

###sheet1 at_the_moment_value
### m:経過した月、ms:毎月の貯金額、r:金利、ms_r:各貯金の1か月経過後の運用額、cum_ms:毎月貯金額累計（金利なし）
### cum_ms_r_moment:毎月の運用額の累計、percent:毎月の累計運用額 / 毎月貯金累計（金利なし）
### n:金利が2年後までにcompoundされる回数（例：1か月目はn = 24)、cum_ms_r_future:2年経過後の各貯金額の累計


m &lt;- 1:24 # 1か月目から、24か月目の期末まで
ms &lt;- rep(5, length(m)) 　
r &lt;- rep(0.05, length(m))
ms_r &lt;- ms * (1 + r)
cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
cum_ms_r_moment &lt;- (5 * (1.05) - (5 * 1.05 ^ (1:24 + 1))) / (1 - 1.05)  # その時の運用額累計を表示したい
percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
n &lt;- 24:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
r2 &lt;- (1 + r / 12) ^ sort(length(n):1, decreasing = TRUE)
#2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
ms_r2 &lt;- ms * r2
cum_ms_r2_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視

## データフレーム化
plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                   n, r2, ms_r2, cum_ms_r2_future)
head(plan)

library(ggplot2)

## グラフ表示
ggplot(plan, aes(x = m)) +
  geom_smooth(aes(y = cum_ms)) +
  geom_smooth(aes(y = cum_ms_r_moment))

##　データフレームを自動で作れる関数を作る
saving_plan &lt;- function(Month, Save, R) {
  m &lt;- 1:Month # 一か月目から、24か月目の期末まで
  ms &lt;- rep(Save, length(m)) 　
  r &lt;- rep(R, length(m))
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (Save * (1 + R) - (Save * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # 2年後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # 24か月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}

df &lt;- saving_plan(24, 5, 0.05)
datatable(df)

## 複数のプランを比べる

### 複数のプランをつくる。
A &lt;- saving_plan(24, 5, 0.05)
B &lt;- saving_plan(24, 5, 0.075)
C &lt;- saving_plan(24, 5, 0.1)

### 複数のプランを作る際に必要な項目に絞る
plans &lt;- data.frame(A[1],A[6],B[6], C[6]) %&gt;% as_tibble()
plans2 &lt;- plans %&gt;% 
  select(
    Month = m, 
    caseA = cum_ms_r_moment,
    caseB = cum_ms_r_moment.1,
    caseC = cum_ms_r_moment.2
  ) 

plans2

### グラフ化する
ggplot(plans2, aes(x = Month)) +
  geom_smooth(aes(y = caseA)) +
  geom_smooth(aes(y = caseB)) +
  geom_smooth(aes(y = caseC)) 


# モデルを複雑化する そろそろエクセルじゃ限界か？

## 前提条件
### interest rateは、期末に支払われる。
### 途中で貯蓄を引き出すことはできない。
### 金利と毎月の貯金額は一定。
# →月々の貯金を時間と共に増加させる
# →金利は金利を固定ではなく、金利をr%を平均値とする正規分布に近似する複利に変える。
#つまり、リスク資産で運用する場合を想定する。
### 毎月の貯金額は、5万円。
### 運用期間は、2年間（24か月）

## 関数を作る
saving_plan2 &lt;- function(Month, Save_first, Increase_by, R, SD) {
  m &lt;- 1:Month # 一か月目から、mか月目の期末まで
  ms &lt;- seq(Save_first, by = Increase_by, length.out = Month)  　
  r &lt;- rnorm(n = Month, mean = R, sd = SD)
  ms_r &lt;- ms * (1 + r)
  cum_ms &lt;- cumsum(ms) # 金利なしver.の貯金額を知りたい
  cum_ms_r_moment &lt;- (ms * (1 + R) - (ms * (1 + R) ^ (m + 1))) / (1 - (1 + R))  # その時の運用額累計を表示したい
  percent &lt;- cum_ms_r_moment / cum_ms # 金利ありｖｓ金利なしを比較したい
  n &lt;- Month:1　# 貯金開始１か月目の貯金額に対しては24回金利のcompoundがある
  r2 &lt;- (1 + r / 12) ^ seq(length(n):1) # mヶ月後の視点から見て、毎月の金利が結果いくらになるのか知りたい
  cum_ms_r_future &lt;- cumsum(ms_r2) # mか月目の項目以外は無視
  
  plan &lt;- data.frame(m, ms, r, ms_r, cum_ms, cum_ms_r_moment, percent,
                     n, r2, cum_ms_r_future)
}

###確認する

plan3 &lt;- saving_plan2(24, 50000, 1000, 0.05, 1)


### グラフ化する

ggplot(plan3, aes(x = m)) +
  geom_smooth(aes(y = cum_ms_r_moment, colour = &quot;積み立て（金利あり）&quot;)) +
  geom_smooth(aes(y = cum_ms, colour = &quot;積み立て（金利なし）&quot;)) +
  scale_y_continuous(labels = comma) +
  xlab(&quot;ヶ月&quot;) +
  ylab(&quot;円&quot;)</code></pre>
</div>
</div>
</div>
